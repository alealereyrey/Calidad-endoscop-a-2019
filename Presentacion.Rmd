---
title: "Calidad endoscopía 2019"
author: "Ale"
date: "6 de julio de 2020"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Para comenzar, cargo todas las librerías que voy a usar

```{r echo=TRUE, results='hide'}
library(tidyverse)
library(dplyr)
library(gapminder)
library(readxl)
library(RUMBA)
library(sf)
library(osmdata)
library(ggmap)
library(janitor)
library(lubridate)
```

## Cargo las bases de datos y creo una sola tabla con las columnas de Saavedra. 

```{r}
lh <- read_excel("C:/Users/Ale/Desktop/Calidad-endoscop-a-2019/lh_2019.xlsx")
saavedra <- read_excel("C:/Users/Ale/Desktop/Calidad-endoscop-a-2019/saavedra.xlsx", guess_max = 20000)

head(lh)
head(saavedra)
tail(saavedra)
colnames(saavedra)
colnames(lh)

```


## filtro observaciones 2019 de saavedra
## Uno ambos df y filtro las columnas que me interesan

```{r}

saavedra2019 <- saavedra %>% 
        filter(FecEstudio >= "2019-01-01" & FecEstudio < "2020-01-01")



total <- bind_rows(saavedra2019, lh)

colnames(total)

total_sedes <- total %>%
        select(c("Edad", "Terapeutica", "Operador",  "Indicacion" ,  "Cobertura",  "HistClinicaNro", "Drogas", "Anestesiologo",     "Terapeutica", "Biopsia",  "Esofago", "Estomago", "Duodeno", "Colonoscopia", "Conclusiones1", "Conclusiones2", "Conclusiones3", "TipEs", "FecEstudio", "Sexo", "BostonI", "BostonD", "BostonT", "BostonTotal", "Preparacion", "PreparadoCon", "Asistente", "Direccion", "Paciente", "FecNacimiento", "AfiliadoNro")) %>%
         mutate_at(vars(which(sapply(., is.character))), str_to_upper) 

head(total_sedes)
str(total_sedes)
```


## Anonimizo y selecciono los operadores que me interesan

```{r}

unique(total_sedes$Operador)


A <- total_sedes$Operador %in% c("PERALTA", "ANGEL DANIEL PERALTA MN 92.347")
B <- total_sedes$Operador %in% "PABLO OLIVERA SENDRA MN 129.392"
C <- total_sedes$Operador %in% "RAFAEL MOORE MN 85.298"
D <- total_sedes$Operador %in% "IGNACIO FANJUL MN 126.170"
E <- total_sedes$Operador %in% c("LUIS SOIFER MN 44.599","SOIFER")
J <- total_sedes$Operador %in% "ALEJANDRO REY MN 134.017"
G <- total_sedes$Operador %in% c("JUAN LASA MN 119.929","JUAN LASA MN 119929")
H <- total_sedes$Operador %in% "DIMA GUILLERMO MN84344"
I <- total_sedes$Operador %in% c("DR. GUSTAVO CERNADAS MN 137.352","GUSTAVO CERNADAS MN 137.352","GUSTAVO CERNADAS M.N. 137.352")


total_sedes$Operador[A] <- "A"
total_sedes$Operador[B] <- "B"
total_sedes$Operador[C] <- "C"
total_sedes$Operador[D] <- "D"
total_sedes$Operador[E] <- "E"
total_sedes$Operador[G] <- "G"
total_sedes$Operador[H] <- "H"
total_sedes$Operador[I] <- "I"
total_sedes$Operador[J] <- "J"

total_sedes_operador <- total_sedes %>%
        filter(Operador %in% c("A", "B", "C", "D", "E", "G", "H", "I", "J"))

unique(total_sedes_operador$Operador)

```

## Limpio las terapéuticas

```{r}

## Itero con unique hasta limpiar todas las terapéuticas

unique(total_sedes_terapeutica$Terapeutica)


total_sedes_terapeutica <- total_sedes_operador %>%
        mutate(Terapeutica = case_when(str_detect(Terapeutica, regex("POL(I|P)")) ~ "POLIPECTOMIA",
                                       str_detect(Terapeutica, regex("MUCO")) ~ "MUCOSECTOMIA",
                                       str_detect(Terapeutica, regex("ARG(O|Ó)N|APC")) ~ "COAGULACION CON ARGON PLASMA",
                                       str_detect(Terapeutica, regex("GASTROST")) &! str_detect(Terapeutica, regex("RECAMBIO"))~ "GASTROSTOMIA ENDOSCOPICA", 
                                       str_detect(Terapeutica, regex("ACALASIA")) ~ "DILATACION ACALASIA",
                                       str_detect(Terapeutica, regex("DILATACI(O|Ó)N")) &! (str_detect(Terapeutica, regex("ANASTO")) | str_detect(Terapeutica, regex("CRICO")) | str_detect(Terapeutica, regex("ACALASIA"))) ~ "DILATACION ESOFAGICA",
                                       str_detect(Terapeutica, regex("CRICO")) ~ "DILATACION CRICOFARINGEO",
                                       str_detect(Terapeutica, regex("EXTRAÑO")) ~ "EXTRACCION DE CUERPO EXTRAÑO",
                                       str_detect(Terapeutica, regex("HEMOSTASIA|SANGRAN|CLIP|BIPOLAR")) ~ "HEMOSTASIA DE LESION SANGRANTE",
                                       str_detect(Terapeutica, regex("LIGADURA|BAND")) ~ "LIGADURA DE VÁRICES ESOFAGICAS",
                                       str_detect(Terapeutica, regex("SONDA|SNG|(K)108")) ~ "COLOCACION DE SONDA NASOGASTRICA",
                                       str_detect(Terapeutica, regex("ANASTOM|QX")) ~ "DILATACION DE ANASTOMOSIS",
                                       str_detect(Terapeutica, regex("CAPSULA|ENDOC(A|Á)PSULA")) ~ "COLOCACION DE ENDOCAPSULA",
                                       str_detect(Terapeutica, regex("EXCLEROSIS|ESCL(A|E)ROSIS")) ~ "ESCLEROSIS DE ANGIODISPLASIAS",
                                       str_detect(Terapeutica, regex("BOTOX|BOTULIN")) ~  "APLICACION TOXINA BOTULINICA",
                                       str_detect(Terapeutica, regex("RECAMBIO DE BOTON")) ~  "RECAMBIO DE GASTROSTOMIA",
                                       str_detect(Terapeutica, regex("LESIONES")) & str_detect(Indicacion, regex("PROCTORRAGIA")) ~  "ESCLEROSIS DE ANGIODISPLASIAS",
                                                                                     str_detect(Terapeutica, regex("LESIONES")) &! str_detect(Indicacion, regex("PROCTORRAGIA")) ~  "HEMOSTASIA DE LESION SANGRANTE",
                                                                              TRUE ~ Terapeutica),           
               Terapeutica = if_else(str_detect(Colonoscopia, regex("POLI")) & is.na(Terapeutica),"POLIPECTOMIA", Terapeutica))


## "Urgencia diurna" no fue una terapeutica por lo que lo transformo en NA

total_sedes_terapeutica$Terapeutica[total_sedes_terapeutica$Terapeutica == "URGENCIA DIURNA"] <- NA

## Elimino el estudio "NO REALIZADO"

total_sedes_terapeutica<- total_sedes_terapeutica[ !(total_sedes_terapeutica$Terapeutica %in% "NO REALIZADO"), ]

## Emprolijo algunos términos

total_sedes_terapeutica$Terapeutica[total_sedes_terapeutica$Terapeutica == "STENT ESOFAGICO -ACOMODACION"] <- "STENT ESOFAGICO (ACOMODACION)"

total_sedes_terapeutica$Terapeutica[total_sedes_terapeutica$Terapeutica == "COLOCACION DE STENT ESOFAGICA"] <- "STENT ESOFAGICO (COLOCACION)"

total_sedes_terapeutica$Terapeutica[total_sedes_terapeutica$Terapeutica == "RETIRO DE STENT ESOFAGICO"] <- "STENT ESOFAGICO (RETIRO)"




para_leer <- total_sedes_terapeutica[which(total_sedes_terapeutica$Terapeutica == "TERMOCOAGULACIÓN BIPOLAR"), ]

prueba <- total_sedes_terapeutica

prueba <- prueba[-(para_leer), ]

para_leer



```









## Agrego geolocalización

```{r}
geo <- USIG_geocode(c("AV GRAL LAS HERAS 2900","GALVAN 4105"))

total <- cbind(estudios_total, geo) %>%
                        rename(Sede = address_normalised) %>%
                        select(-Direccion)

head(total)
```

## Cosas que voy haciendo que resultan utiles

```{r}

## seleccionar una fila según una observacion

nombres <- bind_rows(saavedra2019, lh) 

unique(nombres$TipEs)

o <- nombres$TipEs == "O"

nombres [o,]


## crear un archivo par apedir las AP

nombres <- total_sedes_terapeutica %>% 
        filter (TipEs == "C" & (Terapeutica == "POLIPECTOMIA"| Terapeutica == "MUCOSECTOMIA")) %>% 
        select( "FecEstudio", "Paciente", "FecNacimiento","HistClinicaNro", "Cobertura", "AfiliadoNro")

dif <-anti_join(total_sedes_terapeutica,nombres)

write.csv(nombres, "C:/Users/Ale/Desktop/Calidad-endoscop-a-2019/listaap.csv", row.names = FALSE)


library(writexl)

write_xlsx(nombres, "C:/Users/Ale/Desktop/Calidad-endoscop-a-2019/listaap.xlsx")
```

